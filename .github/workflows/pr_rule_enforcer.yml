# Check PR if all committing rules are being followed
name: PR rule enforcer

on:
  pull_request_target:

env:
  BRANCH_NAME: ${{ github.head_ref }}

jobs:
  # Head branch must start with predefinied prefix
  check_head_branch_name:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Check head branch
        run: |
          echo "Branch name is: $BRANCH_NAME"

          if [[ "$BRANCH_NAME" == repo/*  || 
                "$BRANCH_NAME" == docs/*  || 
                "$BRANCH_NAME" == bug/*   ||
                "$BRANCH_NAME" == devel/* ||
                "$BRANCH_NAME" == feature/* ]]; then
            echo "$BRANCH_NAME is allowed to be merged into master"
          else
            exit 1
          fi

      - name: Post comment if head name is not a valid one
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const body = `
            ⚠️ Branch name must follow contribution guidelines. Check README for details.
            `;
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

  # Commits must be signed
  check_signoff:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check commit sign-offs
        id: check
        run: |
          COMMITS=$(git log origin/${{ github.base_ref }}..HEAD~ --pretty=format:"%H")
          echo "Base ref: origin/${{ github.base_ref }}"
          echo "$COMMITS"
          UNSIGNED=""
          for COMMIT in $COMMITS; do
            if ! git show -s --format=%B $COMMIT | grep -q "Signed-off-by:"; then
              AUTHOR=$(git show -s --format=%an $COMMIT)
              UNSIGNED="${UNSIGNED}\n- ${COMMIT} by ${AUTHOR}"
            fi
          done
          if [ -n "$UNSIGNED" ]; then
            echo "❌ Found unsigned commits:"
            echo -e "$UNSIGNED"
            echo "unsigned<<EOF" >> $GITHUB_OUTPUT
            echo -e "$UNSIGNED" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "✅ All commits are signed off."
          fi

      - name: Post comment if unsigned commits found
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const body = `
            ⚠️ Some commits in this PR are missing a "Signed-off-by" line.
            Unsigned commits:
            ${{ steps.check.outputs.unsigned }}
            `;
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });