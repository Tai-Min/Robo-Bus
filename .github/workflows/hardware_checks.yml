# Run KiCad checks
name: Hardware checks

on:
  workflow_call:
    inputs:
      base_ref:
        required: true
        type: string
      head_ref:
        required: true
        type: string
      pr_number:
        required: true
        type: string
      repo_name:
        required: true
        type: string
    outputs:
      comment:
        description: Comment from job or empty if the job was skipped
        value: ${{ jobs.hardware_checks.outputs.comment }}
      skipped:
        description: true if skipped, empty otherwise
        value: ${{ jobs.handle_skipped.outputs.skipped }}

jobs:
  filter:
    runs-on: ubuntu-latest
    outputs:
      schematics: ${{ steps.filter.outputs.schematics }}
      schematics_files: ${{ steps.filter.outputs.schematics_files }}
      pcb: ${{ steps.filter.outputs.pcb }}
      pcb_files: ${{ steps.filter.outputs.pcb_files }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.head_ref }}
          repository: ${{ inputs.repo_name }}
          fetch-depth: 0

      - name: Check if schematics or pcbs were changed
        uses: dorny/paths-filter@v3
        id: filter
        with:
          list-files: shell
          filters: |
            schematics:
              - added|modified: '**/*.kicad_sch'
            pcb:
              - added|modified: '**/*.kicad_pcb'

      - name: Echo schematics
        if: steps.filter.outputs.schematics == 'false'
        run: echo "No schematics to check"

      - name: Echo PCB
        if: steps.filter.outputs.pcb == 'false'
        run: echo "No PCB to check"

  hardware_checks:
    needs: filter
    if: needs.filter.outputs.schematics == 'true' || needs.filter.outputs.pcb == 'true'

    runs-on: ubuntu-22.04
    env:
      AUTO_BRANCH: ${{ inputs.head_ref }}-PR${{ inputs.pr_number }}-AUTO
    permissions:
      pull-requests: write
      contents: write
    outputs:
      comment: ${{ steps.comment.outputs.comment }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.head_ref }}
          repository: ${{ inputs.repo_name }}
          fetch-depth: 0
          
      - name: Install KiCad
        run: |
          sudo add-apt-repository -y ppa:kicad/kicad-9.0-releases
          sudo apt update
          sudo apt install kicad=9.0.6~ubuntu22.04.1 kicad-libraries kicad-symbols kicad-footprints --no-install-recommends
          mkdir -p ~/.config/kicad/9.0
          cp /usr/share/kicad/template/sym-lib-table ~/.config/kicad/9.0/sym-lib-table
          cp /usr/share/kicad/template/fp-lib-table ~/.config/kicad/9.0/fp-lib-table
          #cp /usr/share/kicad/template/sym-lib-table ~/.config/kicad/9.0/sym-lib-table

          mkdir -p ./results

      - name: Check schematics
        id: check_schematics
        if: needs.filter.outputs.schematics == 'true'
        run: |
          mkdir -p erc
          mkdir -p schematics

          FILES="${{ needs.filter.outputs.schematics_files }}"
          FILES=$(echo "$FILES" | tr ' ' '\n')

          echo "$FILES"

          # Ignore CvPcb warning on fresh install
          FIRST_FILE=$(echo "$FILES" | head -n 1)
          echo "$FIRST_FILE"
          kicad-cli sch erc "$FIRST_FILE" --output "./result.rpt"

          RESULT=""
          for FILE in $FILES; do
            OUT=$(kicad-cli sch erc "$FILE" --output "./erc/$FILE.rpt")
            OUT=$(echo "$OUT" | head -n 1)
            RESULT="${RESULT}\n- ${FILE}: [report](https://github.com/Tai-Min/Robo-Bus/blob/$AUTO_BRANCH/erc/$FILE.rpt)\n$OUT"

            kicad-cli sch export svg "$FILE" --output "./schematics"
          done

          echo -e "$RESULT"

          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo -e "$RESULT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo -e "$RESULT" > ./results/erc.txt

          SCHEMATICS=""
          for i in $(ls ./schematics); do 
            SCHEMATICS="${SCHEMATICS}\n- $i"
            SCHEMATICS="${SCHEMATICS}\n![KiCad schematic](https://raw.githubusercontent.com/Tai-Min/Robo-Bus/$AUTO_BRANCH/schematics/$i)"
          done

          echo -e "$SCHEMATICS"

          echo "schematics<<EOF" >> $GITHUB_OUTPUT
          echo -e "$SCHEMATICS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          exit 0

      - name: Check PCB
        id: check_pcb
        if: needs.filter.outputs.pcb == 'true'
        run: |
          mkdir -p drc
          mkdir -p pcb

          FILES="${{ needs.filter.outputs.pcb_files }}"
          FILES=$(echo "$FILES" | tr ' ' '\n')

          echo "$FILES"

          RESULT=""
          PCB=""
          for FILE in $FILES; do
            echo "$FILE"
            OUT=$(kicad-cli pcb drc "$FILE" --output "./drc/$FILE.rpt" --schematic-parity)
            OUT=$(echo "$OUT" | head -n 3)
            RESULT="${RESULT}\n- ${FILE}: [report](https://github.com/Tai-Min/Robo-Bus/blob/$AUTO_BRANCH/drc/$FILE.rpt)\n$OUT"

            kicad-cli pcb export svg "$FILE" --output "./pcb/$FILE.svg" --layers F.Cu,B.Cu,Edge.Cuts --fit-page-to-board --mode-single
            PCB="${PCB}\n- ./pcb/$FILE.svg"
            PCB="${PCB}\n![KiCad PCB](https://raw.githubusercontent.com/Tai-Min/Robo-Bus/$AUTO_BRANCH/pcb/$FILE.svg)"
          done

          echo -e "$RESULT"

          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo -e "$RESULT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo -e "$RESULT" > ./results/drc.txt

          echo "$PCB"

          echo "pcb<<EOF" >> $GITHUB_OUTPUT
          echo -e "$PCB" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          exit 0

      - name: Upload hardware checks
        uses: actions/upload-artifact@v4
        with:
          name: hardware_checks-PR${{ inputs.pr_number }}
          overwrite: 'true'
          path: |
            erc/
            schematics/
            drc/
            pcb/
            results/

      - name: Committer check
        id: committer_check
        uses: Tai-Min/Robo-Bus/.github/actions/committer_check@master
        with:
          repo: Tai-Min/Robo-Bus
          pr_number: ${{ github.event.pull_request.number }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Push reports to git
        if: steps.committer_check.outputs.association == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr checkout ${{ github.event.pull_request.number }}
          git config --global user.email "bot@bots.robobus"
          git config --global user.name "BOT"
          git branch $AUTO_BRANCH
          git checkout $AUTO_BRANCH
          git add .
          git commit -m "AUTO: Update reports" -s
          git push origin $AUTO_BRANCH -f

      - name: Create markdown for results comment
        id: comment
        run: |
          COMMENT=""
          if [[ ${{ steps.committer_check.outputs.association }} = 'true' ]]; then
            if [[ -n "${{ steps.check_schematics.outputs.result }}" ]]; then
              COMMENT="### Schematics ERC results:"
              COMMENT="${COMMENT}\n${{ steps.check_schematics.outputs.result }}"
            fi

            if [[ -n "${{ steps.check_schematics.outputs.schematics }}" ]]; then
              COMMENT="${COMMENT}\n### Schematics:"
              COMMENT="${COMMENT}\n${{ steps.check_schematics.outputs.schematics }}"
            fi

            if [[ -n "${{ steps.check_pcb.outputs.result }}" ]]; then
              COMMENT="${COMMENT}\n### PCB DRC results:"
              COMMENT="${COMMENT}\n${{ steps.check_pcb.outputs.result }}"
            fi

            if [[ -n "${{ steps.check_pcb.outputs.pcb }}" ]]; then
              COMMENT="${COMMENT}\n### PCB:"
              COMMENT="${COMMENT}\n${{ steps.check_pcb.outputs.pcb }}"
            fi
          else
            if [[ -n "${{ steps.check_schematics.outputs.result }}" ]]; then
              COMMENT="### Schematics ERC results:"
              COMMENT="${COMMENT}\n${{ steps.check_schematics.outputs.result }}"
            fi

            if [[ -n "${{ steps.check_pcb.outputs.result }}" ]]; then
              COMMENT="${COMMENT}\n### PCB DRC results:"
              COMMENT="${COMMENT}\n${{ steps.check_pcb.outputs.result }}\n"
            fi
          fi

          echo "comment<<EOF" >> $GITHUB_OUTPUT
          echo -e "$COMMENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  handle_skipped:
    needs: filter
    if: needs.filter.outputs.schematics == 'false' && needs.filter.outputs.pcb == 'false'
    uses: Tai-Min/Robo-Bus/.github/workflows/handle_skipped.yml@master